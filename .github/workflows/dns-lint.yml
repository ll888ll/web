name: DNS Lint

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

env:
  DOMAIN: ${{ secrets.BIND_DOMAIN != '' && secrets.BIND_DOMAIN || 'croody.app' }}
  TSIG_KEY_NAME: ${{ secrets.BIND_TSIG_KEY_NAME != '' && secrets.BIND_TSIG_KEY_NAME || 'lint-key' }}
  TSIG_KEY_SECRET: ${{ secrets.BIND_TSIG_KEY_SECRET != '' && secrets.BIND_TSIG_KEY_SECRET || 'ZmFrZQ==' }}
  NS1_FQDN: ns1.${{ secrets.BIND_DOMAIN != '' && secrets.BIND_DOMAIN || 'croody.app' }}.
  NS2_FQDN: ns2.${{ secrets.BIND_DOMAIN != '' && secrets.BIND_DOMAIN || 'croody.app' }}.
  SLAVE_IP: ${{ secrets.BIND_SLAVE_PRIVATE_IP != '' && secrets.BIND_SLAVE_PRIVATE_IP || '127.0.0.1' }}

jobs:
  dns-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure zone file exists
        run: |
          ZONE_FILE="infra/dns/bind-master/zones/${DOMAIN}.db"
          if [[ ! -f "$ZONE_FILE" ]]; then
            echo "Missing $ZONE_FILE. Run scripts/dns/setup_bind.sh and commit the zone file." >&2
            exit 1
          fi

      - name: Build BIND image (lint)
        run: docker build -t bind-lint infra/dns

      - name: named-checkconf
        run: |
          docker run --rm \
            -e DNS_ROLE=master \
            -e DNS_DOMAIN="${DOMAIN}" \
            -e TSIG_KEY_NAME="${TSIG_KEY_NAME}" \
            -e TSIG_KEY_SECRET="${TSIG_KEY_SECRET}" \
            -e NS1_FQDN="${NS1_FQDN}" \
            -e NS2_FQDN="${NS2_FQDN}" \
            -e ALLOW_TRANSFER="${SLAVE_IP};" \
            -e ALLOW_QUERY="any;" \
            -v "${PWD}/infra/dns/bind-master/zones:/zones" \
            bind-lint named-checkconf /etc/bind/named.conf

      - name: named-checkzone
        run: |
          docker run --rm \
            -e DNS_ROLE=master \
            -e DNS_DOMAIN="${DOMAIN}" \
            -e TSIG_KEY_NAME="${TSIG_KEY_NAME}" \
            -e TSIG_KEY_SECRET="${TSIG_KEY_SECRET}" \
            -e NS1_FQDN="${NS1_FQDN}" \
            -e NS2_FQDN="${NS2_FQDN}" \
            -v "${PWD}/infra/dns/bind-master/zones:/zones" \
            bind-lint named-checkzone "${DOMAIN}" "/zones/${DOMAIN}.db"

      - name: dig @localhost (SOA)
        run: |
          # Stop systemd-resolved to free port 53 on GitHub Actions runners
          sudo systemctl stop systemd-resolved || true
          # Override environment for docker compose
          export DNS_DOMAIN="${DOMAIN}"
          export NS1_FQDN="${NS1_FQDN}"
          export NS2_FQDN="${NS2_FQDN}"
          export TSIG_KEY_NAME="${TSIG_KEY_NAME}"
          export TSIG_KEY_SECRET="${TSIG_KEY_SECRET}"
          docker compose -f infra/dns/docker-compose.yml up -d bind-master
          sleep 5
          dig @127.0.0.1 "${DOMAIN}" SOA
          docker compose -f infra/dns/docker-compose.yml down
