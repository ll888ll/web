name: Deploy (Self-Hosted)

on:
  push:
    branches: [ main ]
permissions:
  contents: read

jobs:
  deploy:
    runs-on: [self-hosted, linux, deploy]
    concurrency:
      group: deploy-production
      cancel-in-progress: false
    env:
      CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare environment file
        shell: bash
        run: |
          set -euo pipefail
          PERSIST_DIR="$HOME/.telematicache"
          LEGACY_ENV="$HOME/repo/proyecto_integrado/.env"
          mkdir -p "$PERSIST_DIR"
          # Seed from legacy path if exists
          if [ -f "$LEGACY_ENV" ]; then
            cp "$LEGACY_ENV" "$PERSIST_DIR/.env"
          fi
          # Ensure .env exists in persistent dir
          if [ -f "$PERSIST_DIR/.env" ]; then
            cp "$PERSIST_DIR/.env" "$GITHUB_WORKSPACE/proyecto_integrado/.env"
          else
            echo "WARNING: No persistent .env found; using defaults if any" >&2
          fi

      - name: Build & Restart stack
        working-directory: ${{ github.workspace }}/proyecto_integrado
        run: |
          docker compose down || true
          docker compose up -d --build telemetry-gateway ids-ml robot-sim croody gateway
          docker compose ps

      - name: Purge Cloudflare cache (optional)
        if: ${{ env.CF_API_TOKEN != '' && env.CF_ZONE_ID != '' }}
        run: |
          curl -fsSL -X POST \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/json" \
            https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/purge_cache \
            --data '{"purge_everything":true}'

      - name: Configure Cloudflare DNS + SSL (optional)
        if: ${{ env.CF_API_TOKEN != '' && env.CF_ZONE_ID != '' }}
        shell: bash
        run: |
          set -euo pipefail
          # Dependencies
          if ! command -v jq >/dev/null 2>&1; then
            sudo dnf install -y jq || sudo apt-get update -y && sudo apt-get install -y jq || true
          fi
          # Discover zone name and public IP of this instance
          ZONE_NAME=$(curl -fsSL -H "Authorization: Bearer $CF_API_TOKEN" https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID | jq -r '.result.name')
          PUBIP=$(curl -fsSL http://169.254.169.254/latest/meta-data/public-ipv4 || echo '')
          echo "Zone: $ZONE_NAME | IP: $PUBIP"
          test -n "$ZONE_NAME" && test -n "$PUBIP"

          # Upsert A record for root
          ROOT_REC_ID=$(curl -fsSL -H "Authorization: Bearer $CF_API_TOKEN" "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records?type=A&name=$ZONE_NAME" | jq -r '.result[0].id // empty')
          if [ -n "$ROOT_REC_ID" ]; then
            curl -fsSL -X PUT -H "Authorization: Bearer $CF_API_TOKEN" -H "Content-Type: application/json" \
              "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records/$ROOT_REC_ID" \
              --data "{\"type\":\"A\",\"name\":\"$ZONE_NAME\",\"content\":\"$PUBIP\",\"proxied\":true}"
          else
            curl -fsSL -X POST -H "Authorization: Bearer $CF_API_TOKEN" -H "Content-Type: application/json" \
              "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records" \
              --data "{\"type\":\"A\",\"name\":\"$ZONE_NAME\",\"content\":\"$PUBIP\",\"proxied\":true}"
          fi

          # Upsert CNAME for www
          WWW_NAME="www.$ZONE_NAME"
          WWW_REC_ID=$(curl -fsSL -H "Authorization: Bearer $CF_API_TOKEN" "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records?type=CNAME&name=$WWW_NAME" | jq -r '.result[0].id // empty')
          if [ -n "$WWW_REC_ID" ]; then
            curl -fsSL -X PUT -H "Authorization: Bearer $CF_API_TOKEN" -H "Content-Type: application/json" \
              "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records/$WWW_REC_ID" \
              --data "{\"type\":\"CNAME\",\"name\":\"$WWW_NAME\",\"content\":\"$ZONE_NAME\",\"proxied\":true}"
          else
            curl -fsSL -X POST -H "Authorization: Bearer $CF_API_TOKEN" -H "Content-Type: application/json" \
              "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records" \
              --data "{\"type\":\"CNAME\",\"name\":\"$WWW_NAME\",\"content\":\"$ZONE_NAME\",\"proxied\":true}"
          fi

          # SSL Strict
          curl -fsSL -X PATCH -H "Authorization: Bearer $CF_API_TOKEN" -H "Content-Type: application/json" \
            "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/settings/ssl" \
            --data '{"value":"strict"}'

          # Bot Fight Mode ON
          curl -fsSL -X PATCH -H "Authorization: Bearer $CF_API_TOKEN" -H "Content-Type: application/json" \
            "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/settings/bot_fight_mode" \
            --data '{"value":"on"}'

          echo "Cloudflare DNS + SSL configured."
