{% extends 'base.html' %}
{% load static %}

{% block title %}Tienda Buddy ¬∑ Croody{% endblock %}
{% block header_cta_url %}{% url 'shop:checkout-preview' %}{% endblock %}

{% block body %}
  <main id="main" tabindex="-1">
    <section class="page-hero" aria-labelledby="store-title">
      <div class="container page-hero__grid">
        <div class="page-hero__content">
          <div class="chip">Tienda Buddy</div>
          <h1 id="store-title">Todo lo que necesitas para entrenar</h1>
          <p>Cofres, sets, accesorios. Compra directo, recibe al instante.</p>
          <div class="page-hero__cta">
            <a class="btn btn--primary" href="#catalogo">Ver Cat√°logo</a>
          </div>
          <div class="category-chips" style="margin-top: var(--space-3); display: flex; gap: var(--space-2); flex-wrap: wrap;">
            <button class="chip active" data-filter="all">Todo</button>
            <button class="chip" data-filter="cofre">Cofres</button>
            <button class="chip" data-filter="set">Sets</button>
            <button class="chip" data-filter="accesorio">Accesorios</button>
          </div>
        </div>
      </div>
    </section>

    <section id="catalogo" class="section store-catalog-ultra" aria-labelledby="catalogue-title">
      <div class="container">
        <h2 id="catalogue-title">Cat√°logo Buddy</h2>
        {% if products %}
          <div class="product-grid-ultra">
            {% for product in products %}
              <article class="product-card-ultra" data-type="{{ product.category|default:'general' }}">
                <div class="product-image">
                  <div class="product-emoji">
                    {% if 'Pro' in product.name %}üíé{% elif 'Basic' in product.name %}‚≠ê{% elif 'Skin' in product.name %}üé®{% elif 'Rutina' in product.name %}üí™{% elif 'Annual' in product.name %}üèÜ{% else %}üéØ{% endif %}
                  </div>
                  {% if product.badge_label %}
                    <span class="chip chip--outline product-badge">{{ product.badge_label }}</span>
                  {% endif %}
                </div>
                <h3 class="product-title">{{ product.name }}</h3>
                <p class="product-teaser">{{ product.teaser }}</p>
                <div class="product-footer">
                  <span class="product-price">${{ product.price|floatformat:0 }}</span>
                  <span class="product-delivery">{{ product.delivery_estimate }}</span>
                </div>
                <button class="btn btn--primary add-to-cart-btn" data-product-id="{{ product.id }}" data-product-slug="{{ product.slug }}">
                  Agregar al carrito
                </button>
              </article>
            {% endfor %}
          </div>
          {% if is_paginated %}
          <nav aria-label="Paginaci√≥n" class="catalog-pagination">
            <div>Mostrando {{ products|length }} productos</div>
            {% if page_obj.has_next %}
              <a class="btn btn--ghost" href="?page={{ page_obj.next_page_number }}">Ver m√°s ‚Üí</a>
            {% endif %}
          </nav>
          {% endif %}
        {% else %}
          <p>No hay productos disponibles.</p>
        {% endif %}
      </div>
    </section>
  </main>
{% endblock %}

{% block body_scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
      addToCartButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
          const productId = btn.dataset.productId;
          const productSlug = btn.dataset.productSlug;
          const originalText = btn.textContent;
          btn.textContent = '‚úì Agregado';
          btn.disabled = true;

          try {
            const response = await fetch('/shop/api/cart/add/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
              },
              body: JSON.stringify({ product_id: productId })
            });

            if (response.ok) {
              showCartToast('Producto agregado al carrito');
              setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
              }, 2000);
            }
          } catch (error) {
            console.error('Error:', error);
            btn.textContent = originalText;
            btn.disabled = false;
          }
        });
      });

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      function showCartToast(message) {
        const toast = document.createElement('div');
        toast.className = 'cart-toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.classList.add('show');
        }, 10);
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
    });
  </script>
{% endblock %}
