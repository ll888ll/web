{% extends "accounts/base_accounts.html" %}
{% load static %}
{% load i18n %}

{% block page_title %}{% trans "Editar Perfil" %}{% endblock %}
{% block content_title %}{% trans "Editar Perfil" %}{% endblock %}

{% block content_actions %}
<a href="{% url 'accounts:profile' %}" class="btn btn--ghost btn--sm">
  {% trans "Cancelar" %}
</a>
{% endblock %}

{% block content %}
<div class="profile-edit">
  <form method="post" enctype="multipart/form-data" class="form-card">
    {% csrf_token %}

    <!-- Profile Picture -->
    <section class="form-section">
      <h3 class="form-section__title">{% trans "Foto de perfil" %}</h3>
      <div class="avatar-upload">
        {% if profile.profile_picture %}
        <img
          src="{{ profile.profile_picture.url }}"
          alt="{{ request.user.username }}"
          class="avatar-upload__preview"
          id="avatar-preview"
        >
        {% else %}
        <div class="avatar-upload__preview avatar-upload__preview--placeholder" id="avatar-preview">
          {{ request.user.username|slice:":1"|upper }}
        </div>
        {% endif %}
        <div class="avatar-upload__controls">
          <label class="btn btn--secondary btn--sm">
            {% trans "Cambiar foto" %}
            <input
              type="file"
              name="profile_picture"
              accept="image/*"
              class="visually-hidden"
              id="profile-picture-input"
            >
          </label>
          <p class="avatar-upload__hint">{% trans "JPG, PNG, GIF o WebP. M\u00e1x 5MB." %}</p>
        </div>
      </div>
      {% if form.profile_picture.errors %}
      <div class="form-error">{{ form.profile_picture.errors }}</div>
      {% endif %}
    </section>

    <!-- Physical Data -->
    <section class="form-section">
      <h3 class="form-section__title">{% trans "Datos f\u00edsicos" %}</h3>
      <div class="form-grid">
        <div class="form-group">
          <label for="id_weight" class="form-label">{% trans "Peso (kg)" %}</label>
          <input
            type="number"
            name="weight"
            id="id_weight"
            class="form-input"
            value="{{ form.weight.value|default:'' }}"
            step="0.1"
            min="20"
            max="300"
            placeholder="{% trans 'Ej: 70.5' %}"
          >
          {% if form.weight.errors %}
          <div class="form-error">{{ form.weight.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="id_height" class="form-label">{% trans "Altura (cm)" %}</label>
          <input
            type="number"
            name="height"
            id="id_height"
            class="form-input"
            value="{{ form.height.value|default:'' }}"
            step="0.1"
            min="100"
            max="250"
            placeholder="{% trans 'Ej: 175' %}"
          >
          {% if form.height.errors %}
          <div class="form-error">{{ form.height.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="id_birth_date" class="form-label">{% trans "Fecha de nacimiento" %}</label>
          <input
            type="date"
            name="birth_date"
            id="id_birth_date"
            class="form-input"
            value="{{ form.birth_date.value|date:'Y-m-d'|default:'' }}"
          >
          {% if form.birth_date.errors %}
          <div class="form-error">{{ form.birth_date.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="id_gender" class="form-label">{% trans "G\u00e9nero" %}</label>
          <select name="gender" id="id_gender" class="form-select">
            <option value="">{% trans "Seleccionar..." %}</option>
            <option value="male" {% if form.gender.value == 'male' %}selected{% endif %}>{% trans "Masculino" %}</option>
            <option value="female" {% if form.gender.value == 'female' %}selected{% endif %}>{% trans "Femenino" %}</option>
            <option value="non_binary" {% if form.gender.value == 'non_binary' %}selected{% endif %}>{% trans "No binario" %}</option>
            <option value="prefer_not_say" {% if form.gender.value == 'prefer_not_say' %}selected{% endif %}>{% trans "Prefiero no decir" %}</option>
          </select>
          {% if form.gender.errors %}
          <div class="form-error">{{ form.gender.errors }}</div>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Bio -->
    <section class="form-section">
      <h3 class="form-section__title">{% trans "Biograf\u00eda" %}</h3>
      <div class="form-group">
        <label for="id_bio" class="form-label">{% trans "Cu\u00e9ntanos sobre ti" %}</label>
        <textarea
          name="bio"
          id="id_bio"
          class="form-textarea"
          rows="4"
          maxlength="500"
          placeholder="{% trans 'Cu\u00e9ntanos sobre ti...' %}"
        >{{ form.bio.value|default:'' }}</textarea>
        <span class="form-hint">{% trans "M\u00e1ximo 500 caracteres" %}</span>
        {% if form.bio.errors %}
        <div class="form-error">{{ form.bio.errors }}</div>
        {% endif %}
      </div>
    </section>

    <!-- Submit -->
    <div class="form-actions">
      <button type="submit" class="btn btn--primary">
        {% trans "Guardar cambios" %}
      </button>
      <a href="{% url 'accounts:profile' %}" class="btn btn--ghost">
        {% trans "Cancelar" %}
      </a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Preview uploaded image
document.getElementById('profile-picture-input').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const preview = document.getElementById('avatar-preview');
      if (preview.tagName === 'IMG') {
        preview.src = e.target.result;
      } else {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.alt = 'Preview';
        img.className = 'avatar-upload__preview';
        img.id = 'avatar-preview';
        preview.replaceWith(img);
      }
    };
    reader.readAsDataURL(file);
  }
});
</script>
{% endblock %}
