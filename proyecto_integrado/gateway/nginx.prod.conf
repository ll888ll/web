map $http_x_request_id $req_id { default $http_x_request_id; }

log_format json_combined escape=json '{"time":"$time_iso8601","remote":"$remote_addr","method":"$request_method","uri":"$request_uri","status":$status,"bytes":$bytes_sent,"req_id":"$req_id","ua":"$http_user_agent","rt":$request_time,"u_rt":"$upstream_response_time"}';

access_log /dev/stdout json_combined;

limit_req_zone $binary_remote_addr zone=api_zone:20m rate=150r/s;

upstream croody_upstream { server croody:8000; keepalive 64; }
upstream telemetry_upstream { server telemetry-gateway:9000; keepalive 64; }
upstream ids_upstream { server ids-ml:9100; keepalive 64; }

server {
  listen 80;
  server_name croody.app www.croody.app;

  location ^~ /.well-known/acme-challenge/ {
    root /var/www/certbot;
    default_type "text/plain";
    allow all;
  }

  location / { return 301 https://$host$request_uri; }
}

server {
  listen 443 ssl http2;
  server_name croody.app www.croody.app;

  ssl_certificate     /etc/letsencrypt/live/croody.app/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/croody.app/privkey.pem;
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers HIGH:!aNULL:!MD5;

  add_header X-Content-Type-Options nosniff;
  add_header X-Frame-Options SAMEORIGIN;
  add_header Referrer-Policy no-referrer-when-downgrade;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header X-Request-ID $req_id;
  add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' data: https:; object-src 'none'; frame-ancestors 'self';";

  proxy_connect_timeout 3s;
  proxy_send_timeout 15s;
  proxy_read_timeout 15s;
  send_timeout 15s;

  location / {
    proxy_pass http://croody_upstream/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Request-ID $req_id;
  }

  location /api/telemetry/ {
    limit_req zone=api_zone burst=150 nodelay;
    proxy_pass http://telemetry_upstream/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Request-ID $req_id;
  }
  location = /api/telemetry/healthz { proxy_pass http://telemetry_upstream/healthz; }
  location = /api/telemetry/docs {
    add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: https:; object-src 'none'; frame-ancestors 'self'";
    proxy_pass http://telemetry_upstream/docs;
  }
  location = /api/telemetry/redoc {
    add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: https:; object-src 'none'; frame-ancestors 'self'";
    proxy_pass http://telemetry_upstream/redoc;
  }
  location = /api/telemetry/openapi.json { proxy_pass http://telemetry_upstream/openapi.json; }

  location /api/ids/ {
    limit_req zone=api_zone burst=150 nodelay;
    proxy_pass http://ids_upstream/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Request-ID $req_id;
  }
  location = /api/ids/healthz { proxy_pass http://ids_upstream/healthz; }
  location = /api/ids/docs {
    add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: https:; object-src 'none'; frame-ancestors 'self'";
    proxy_pass http://ids_upstream/docs;
  }
  location = /api/ids/redoc {
    add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: https:; object-src 'none'; frame-ancestors 'self'";
    proxy_pass http://ids_upstream/redoc;
  }
  location = /api/ids/openapi.json { proxy_pass http://ids_upstream/openapi.json; }
}

