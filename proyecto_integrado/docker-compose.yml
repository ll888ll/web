services:
  gateway:
    image: nginx:alpine
    container_name: gateway_new
    restart: unless-stopped
    ports:
      - "8080:80"
      - "80:80"
      - "8443:443"
      - "443:443"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./gateway/ssl:/etc/nginx/ssl:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1"]
      interval: 10s
      timeout: 3s
      retries: 5
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
    mem_limit: 256m
    cpus: "0.50"
    depends_on:
      - croody
      - telemetry-gateway
      - ids-ml

  croody:
    build:
      context: ./Croody
      dockerfile: Dockerfile
    container_name: croody_new
    restart: unless-stopped
    environment:
      - DJANGO_SETTINGS_MODULE=croody.settings.development
      - DATABASE_URL=sqlite:////data/croody.db
      - DEBUG=True
    volumes:
      - ./Croody:/app
      - croody_data:/data
    expose:
      - "8000"
    ports:
      - "8000:8000"
    mem_limit: 512m
    cpus: "0.50"
    entrypoint: ["/app/entrypoint.sh"]
    command: ["python", "manage.py", "runserver", "0.0.0.0:8000"]
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8000/"]
      interval: 10s
      timeout: 5s
      retries: 10

  telemetry-gateway:
    build:
      context: ./services/telemetry-gateway
      dockerfile: Dockerfile
    container_name: telemetry-gateway_new
    restart: unless-stopped
    environment:
      - TG_DB_PATH=/data/telemetry.db
    volumes:
      - telemetry_data:/data
    expose:
      - "9000"
    mem_limit: 512m
    cpus: "0.50"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9000/healthz"]
      interval: 10s
      timeout: 3s
      retries: 5

  ids-ml:
    build:
      context: ./services/ids-ml
      dockerfile: Dockerfile
    container_name: ids-ml_new
    restart: unless-stopped
    volumes:
      - ./services/ids-ml/models:/models
    expose:
      - "9100"
    mem_limit: 512m
    cpus: "0.50"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9100/healthz"]
      interval: 10s
      timeout: 3s
      retries: 5

  robot-sim:
    build:
      context: ./robots/telemetry-robot
    container_name: robot_sim
    restart: unless-stopped
    ports:
      - "9090:9090"
    environment:
      - TELEMETRY_INGEST_URL=http://telemetry-gateway:9000/api/telemetry/ingest
      - ROBOT_ID=robot-clases
    depends_on:
      - telemetry-gateway

volumes:
  croody_data:
  telemetry_data:
